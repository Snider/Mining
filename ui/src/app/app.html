<div class="mining-dashboard">

  <!-- Initial Loading State -->
  @if (systemInfo === null && !needsSetup) {
    <div class="centered-container">
      <wa-card class="card-overview">
        <div slot="header">Loading...</div>
        <wa-spinner style="font-size: 3rem; margin-top: 1rem;"></wa-spinner>
      </wa-card>
    </div>
  }

  <!-- Setup Wizard: Shown when needsSetup is true -->
  @if (needsSetup) {
    <div class="centered-container">
      <wa-card class="card-overview">
        <div slot="header">
          <wa-icon name="wand-magic-sparkles" style="font-size: 2rem;"></wa-icon>
          Welcome! Let's Get Started
        </div>
        <p>To begin, please install a miner from the list below.</p>

        <h4>Available Miners</h4>
        <div class="miner-list">
          @for (miner of manageableMiners; track miner.name) {
            <div class="miner-item">
              <span>{{ miner.name }}</span>
              <wa-button
                variant="success"
                size="small"
                [disabled]="actionInProgress === 'install-' + miner.name"
                (click)="installMiner(miner.name)">
                @if (actionInProgress === 'install-' + miner.name) {
                  <wa-spinner class="button-spinner"></wa-spinner>
                } @else {
                  <wa-icon name="download" slot="prefix"></wa-icon>
                  Install
                }
              </wa-button>
            </div>
          } @empty {
            <div class="miner-item">
              <span>Could not load available miners.</span>
            </div>
          }
        </div>

        <div slot="footer">
          <wa-button (click)="checkSystemState()">
            <wa-icon name="arrow-clockwise" slot="prefix"></wa-icon>
            Refresh Status
          </wa-button>
        </div>
      </wa-card>
    </div>
  }

  <!-- Main Content: API is Available and initial load is complete -->
  @if (systemInfo !== null && apiAvailable && !needsSetup) {
    <div>
      @if (error) {
        <wa-card class="card-error">
          <div slot="header">
            <wa-icon name="exclamation-triangle" style="font-size: 1.5rem;"></wa-icon>
            An Error Occurred
          </div>
          <p>{{ error }}</p>
        </wa-card>
      }

      <wa-card class="card-overview">
        <div slot="header" class="card-header">
          <div class="header-title">
            <wa-icon name="cpu" style="font-size: 1.5rem;"></wa-icon>
            Mining Control
          </div>
          <wa-button variant="neutral" appearance="plain" (click)="toggleAdminPanel()">
            <wa-icon name="gear" label="Admin Panel"></wa-icon>
          </wa-button>
        </div>

        <!-- Admin Panel -->
        @if (showAdminPanel) {
          <div class="admin-panel">
            <h3 class="admin-title">Admin Panel</h3>

            <h4>Manage Miners</h4>
            <div class="miner-list">
              @for (miner of manageableMiners; track miner.name) {
                <div class="miner-item">
                  <span>{{ miner.name }}</span>
                  @if (miner.is_installed) {
                    <wa-button
                      variant="danger"
                      size="small"
                      [disabled]="actionInProgress === 'uninstall-' + miner.name"
                      (click)="uninstallMiner(miner.name)">
                      @if (actionInProgress === 'uninstall-' + miner.name) {
                        <wa-spinner class="button-spinner"></wa-spinner>
                      } @else {
                        <wa-icon name="trash" slot="prefix"></wa-icon>
                        Uninstall
                      }
                    </wa-button>
                  } @else {
                    <wa-button
                      variant="success"
                      size="small"
                      [disabled]="actionInProgress === 'install-' + miner.name"
                      (click)="installMiner(miner.name)">
                      @if (actionInProgress === 'install-' + miner.name) {
                        <wa-spinner class="button-spinner"></wa-spinner>
                      } @else {
                        <wa-icon name="download" slot="prefix"></wa-icon>
                        Install
                      }
                    </wa-button>
                  }
                </div>
              } @empty {
                <div class="miner-item">
                  <span>Could not load available miners.</span>
                </div>
              }
            </div>

            <h4>Antivirus Whitelist Paths</h4>
            <div class="path-list">
              <p>To prevent antivirus software from interfering, please add the following paths to your exclusion list:</p>
              <ul>
                @for (path of whitelistPaths; track path) {
                  <li><code>{{ path }}</code></li>
                }
              </ul>
            </div>
          </div>
        }

        <!-- Miner Control List -->
        @if (installedMiners.length > 0) {
          <div class="miner-list">
            @for (miner of installedMiners; track miner.path) {
              <div class="miner-item-container">
                <div class="miner-item">
                  <span class="miner-name">
                    {{ miner.type }}
                    <wa-tooltip>
                      <div slot="content">Version: {{ miner.version }}</div>
                      <wa-icon name="info-circle"></wa-icon>
                    </wa-tooltip>
                  </span>

                  @if (isMinerRunning(miner)) {
                    <wa-button
                      variant="danger"
                      [disabled]="actionInProgress === 'stop-' + miner.type"
                      (click)="stopMiner(miner)">
                      @if (actionInProgress === 'stop-' + miner.type) {
                        <wa-spinner class="button-spinner"></wa-spinner>
                      } @else {
                        <wa-icon name="stop-circle" slot="prefix"></wa-icon>
                        Stop
                      }
                    </wa-button>
                  } @else {
                    <div class="start-buttons">
                      <wa-button
                        variant="secondary"
                        [disabled]="actionInProgress === 'start-' + miner.type"
                        (click)="startMiner(miner, true)">
                        @if (actionInProgress === 'start-' + miner.type && showStartOptionsFor !== miner.type) {
                          <wa-spinner class="button-spinner"></wa-spinner>
                        } @else {
                          <wa-icon name="play-circle" slot="prefix"></wa-icon>
                          Start Last Config
                        }
                      </wa-button>
                      <wa-button
                        variant="primary"
                        [disabled]="actionInProgress === 'start-' + miner.type"
                        (click)="toggleStartOptions(miner.type)">
                        <wa-icon name="gear" slot="prefix"></wa-icon>
                        New Config
                      </wa-button>
                    </div>
                  }
                </div>

                @if (showStartOptionsFor === miner.type) {
                  <div class="start-options">
                    <wa-input label="Pool Address" [(ngModel)]="poolAddress" name="poolAddress"></wa-input>
                    <wa-input label="Wallet Address" [(ngModel)]="walletAddress" name="walletAddress"></wa-input>
                    <wa-button
                      variant="success"
                      [disabled]="actionInProgress === 'start-' + miner.type"
                      (click)="startMiner(miner)">
                      @if (actionInProgress === 'start-' + miner.type) {
                        <wa-spinner class="button-spinner"></wa-spinner>
                      } @else {
                        <wa-icon name="rocket-launch" slot="prefix"></wa-icon>
                        Confirm & Start
                      }
                    </wa-button>
                  </div>
                }
              </div>
            }
          </div>
        }
      </wa-card>
    </div>
  }

</div>
